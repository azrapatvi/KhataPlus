{% extends "base.html" %}
{% block content %}

<div class="container mt-5">
    <h2 class="mb-3 text-center fw-bold" style="color: #2c3e50;">
        <i class="bi bi-people"></i> Users
    </h2>

    <!-- Search bar -->
    <div class="mb-4 text-center">
        <input type="text" id="user-search" class="form-control" placeholder="Search users by name" style="max-width: 400px; margin:auto;">
    </div>

    <!-- User cards -->
    <div class="row row-cols-1 row-cols-md-3 g-4" id="user-cards">
        {% for name in names %}
        <div class="col user-card-col">
            <button class="card user-card" data-name="{{ name }}" 
                 style="background-color: #aabfec; text-align:center; padding:15px;width: 80%; cursor:pointer;">
                <h5>{{ name }}</h5>
            </button>
        </div>
        {% endfor %}
    </div>

    <hr><br>
    <h2 class="mb-5 text-center fw-bold" style="color: #2c3e50;">
        <i class="bi bi-people"></i> User Details
    </h2>
    <div id="user-details" class="user-details mb-5"></div>
</div>

<!-- jQuery for AJAX -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Hover effect
    $(".user-card").hover(
        function(){ $(this).css({"background-color":"#5e719a","color":"white"}); },
        function(){ $(this).css({"background-color":"#aabfec","color":"black"}); }
    );

    // Click event to load details
    $(".user-card").click(function() {
        let username = $(this).data("name");

        $.ajax({
            url: "/api/user_details/" + username,
            method: "GET",
            success: function(data) {
                let container = $("#user-details");
                container.empty();

                if(data.records.length === 0){
                    container.append("<p>No records for " + username + "</p>");
                } else {
                    let total = 0;
                    data.records.forEach(function(rec){
                        total += parseFloat(rec.amount);
                    });

                    // Add total button
                    container.append(`
  <div class="d-flex justify-content-center">
      <button class="btn btn-success mb-3">Total: â‚¹${total.toFixed(2)}</button>
  </div>
`);


                    // Build table
                    let table = `<table id="user-records" class="table table-bordered mb-2">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                 </table>`;
                    container.append(table);

                    // Append rows
                    data.records.forEach(function(rec){
                        let row = `<tr>
                            <td>${rec.id}</td>
                            <td>${rec.date}</td>
                            <td>${rec.amount}</td>
                            <td>${rec.notes}</td>
                        </tr>`;
                        container.find("tbody").append(row);
                    });
                    

                    // Initialize DataTable for user records
                    $('#user-records').DataTable({
                        paging: true,
                        searching: true,
                        info: true
                    });
                }
            }
        });
    });

    // Filter user cards by search
    $("#user-search").on("keyup", function() {
        let value = $(this).val().toLowerCase();
        $(".user-card-col").filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
    });
});
</script>

<!-- DataTables CSS & JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

{% endblock %}
